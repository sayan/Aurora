<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>model_versioning_and_governance_2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-5d3fd86dc4559d58e199c8cc4a79ed5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="question-discuss-the-importance-of-model-governance-and-outline-the-key-components-that-should-be-included-in-a-robust-model-governance-framework." class="level2">
<h2 class="anchored" data-anchor-id="question-discuss-the-importance-of-model-governance-and-outline-the-key-components-that-should-be-included-in-a-robust-model-governance-framework.">Question: Discuss the importance of model governance and outline the key components that should be included in a robust model governance framework.</h2>
<p><strong>Best Answer</strong></p>
<p>Model governance is crucial for organizations increasingly reliant on machine learning (ML) and artificial intelligence (AI) models. It’s about establishing a framework of policies, procedures, and controls to ensure that models are developed, validated, deployed, and monitored in a responsible, ethical, and compliant manner. Without robust model governance, organizations expose themselves to significant risks, including:</p>
<ul>
<li><strong>Financial risk:</strong> Inaccurate models can lead to poor business decisions, resulting in financial losses.</li>
<li><strong>Reputational risk:</strong> Biased or unfair models can damage an organization’s reputation and erode public trust.</li>
<li><strong>Compliance risk:</strong> Failure to comply with regulations (e.g., GDPR, CCPA, industry-specific regulations) can result in hefty fines and legal action.</li>
<li><strong>Operational risk:</strong> Unreliable or poorly performing models can disrupt business operations and lead to inefficiencies.</li>
<li><strong>Ethical risk:</strong> Models can perpetuate existing biases or create new ones, leading to discriminatory outcomes.</li>
</ul>
<p>A robust model governance framework typically includes the following key components:</p>
<ol type="1">
<li><strong>Model Inventory:</strong>
<ul>
<li>A centralized repository containing comprehensive information about all models used within the organization.</li>
<li>Attributes include: model name, purpose, developer, deployment date, data sources, performance metrics, regulatory requirements, and risk level.</li>
<li>Essential for tracking model lineage and impact.</li>
</ul></li>
<li><strong>Model Development Standards:</strong>
<ul>
<li>Well-defined procedures for model development, including data collection, feature engineering, model selection, training, and validation.</li>
<li>Emphasis on statistical rigor, bias detection and mitigation, and explainability.</li>
<li>Documentation requirements for each stage of the model development lifecycle.</li>
</ul></li>
<li><strong>Model Validation and Testing:</strong>
<ul>
<li>Independent validation of models by a team separate from the development team.</li>
<li>Assessment of model accuracy, stability, and robustness.</li>
<li>Use of diverse datasets and testing scenarios to identify potential weaknesses.</li>
<li>Documentation of validation results and recommendations.</li>
</ul></li>
<li><strong>Model Risk Assessment:</strong>
<ul>
<li>Evaluation of the potential risks associated with each model, considering factors such as data quality, model complexity, and business impact.</li>
<li>Categorization of models based on their risk level (e.g., low, medium, high).</li>
<li>Implementation of risk mitigation strategies for high-risk models.</li>
<li>Risk assessment must be a <em>living document</em>, updated periodically or after significant model changes.</li>
</ul></li>
<li><strong>Model Deployment and Monitoring:</strong>
<ul>
<li><p>Controlled deployment process with clear guidelines for model implementation and integration.</p></li>
<li><p>Continuous monitoring of model performance in production, including key metrics such as accuracy, precision, recall, and F1-score.</p></li>
<li><p>Alerting mechanisms to detect performance degradation or unexpected behavior.</p></li>
<li><p>A feedback loop for retraining models with new data and addressing identified issues.</p></li>
<li><p>Here are some important formulas and metrics:</p>
<ul>
<li><p><strong>Accuracy:</strong> The proportion of correctly classified instances. <span class="math display">\[Accuracy = \frac{TP + TN}{TP + TN + FP + FN}\]</span> where <em>TP</em> is True Positives, <em>TN</em> is True Negatives, <em>FP</em> is False Positives, and <em>FN</em> is False Negatives.</p></li>
<li><p><strong>Precision:</strong> The proportion of predicted positive instances that are actually positive. <span class="math display">\[Precision = \frac{TP}{TP + FP}\]</span></p></li>
<li><p><strong>Recall:</strong> The proportion of actual positive instances that are correctly predicted. <span class="math display">\[Recall = \frac{TP}{TP + FN}\]</span></p></li>
<li><p><strong>F1-Score:</strong> The harmonic mean of precision and recall. <span class="math display">\[F_1 = 2 \cdot \frac{Precision \cdot Recall}{Precision + Recall}\]</span></p></li>
<li><p><strong>Area Under the ROC Curve (AUC-ROC):</strong> Measures the ability of a classifier to distinguish between classes. It ranges from 0 to 1, with a higher value indicating better performance.</p></li>
<li><p><strong>Kolmogorov-Smirnov (KS) statistic:</strong> Used to evaluate the drift in model predictions over time. It measures the maximum difference between the cumulative distribution functions of the predicted probabilities for two samples.</p></li>
<li><p><strong>PSI (Population Stability Index):</strong> <span class="math display">\[PSI = \sum_{i=1}^N (Actual\%_i - Expected\%_i) \cdot ln(\frac{Actual\%_i}{Expected\%_i})\]</span> PSI indicates how much the distribution of a model’s input variables has shifted.</p></li>
</ul></li>
</ul></li>
<li><strong>Model Documentation:</strong>
<ul>
<li>Comprehensive documentation of all aspects of the model, including its purpose, development process, data sources, assumptions, limitations, and performance characteristics.</li>
<li>Version control of documentation to track changes over time.</li>
<li>Documentation should be accessible to all stakeholders.</li>
</ul></li>
<li><strong>Model Versioning:</strong>
<ul>
<li>Systematic tracking of different versions of a model, including changes to the model code, data, and parameters.</li>
<li>Ability to revert to previous versions if necessary.</li>
<li>Clear labeling of model versions to avoid confusion.</li>
<li>Versioning can be implemented using tools like Git or specialized model management platforms.</li>
</ul></li>
<li><strong>Access Control and Security:</strong>
<ul>
<li>Role-based access control to restrict access to models and data based on user roles and responsibilities.</li>
<li>Security measures to protect models from unauthorized access, modification, or destruction.</li>
<li>Encryption of sensitive data used by models.</li>
<li>Regular security audits to identify and address vulnerabilities.</li>
</ul></li>
<li><strong>Audit Trails:</strong>
<ul>
<li>Detailed records of all activities related to the model, including data access, model training, deployment, and performance monitoring.</li>
<li>Audit trails should be tamper-proof and easily accessible for auditing purposes.</li>
<li>Enable tracking of changes to the model and identification of potential issues.</li>
</ul></li>
<li><strong>Explainability and Interpretability:</strong>
<ul>
<li><p>Techniques to understand how the model makes its predictions, especially for high-stakes decisions.</p></li>
<li><p>Methods such as feature importance analysis, SHAP values, and LIME to explain model behavior.</p></li>
<li><p>Transparency in decision-making processes.</p></li>
<li><p>Here are some explainability metrics and formulas:</p>
<ul>
<li><p><strong>SHAP (SHapley Additive exPlanations) values:</strong> assign each feature a measure of its contribution to the prediction. The SHAP value of a feature <span class="math inline">\(i\)</span> for a sample <span class="math inline">\(x\)</span> is given by: <span class="math display">\[\phi_i = \sum_{S \subseteq M \setminus \{i\}} \frac{|S|!(M-|S|-1)!}{M!} (f_x(S \cup \{i\}) - f_x(S))\]</span> where <span class="math inline">\(M\)</span> is the set of all features, <span class="math inline">\(S\)</span> is a subset of features, and <span class="math inline">\(f_x(S)\)</span> is the prediction of the model using only the features in <span class="math inline">\(S\)</span>.</p></li>
<li><p><strong>LIME (Local Interpretable Model-agnostic Explanations):</strong> LIME approximates the behavior of the model locally around a specific data point by fitting a simple, interpretable model (e.g., a linear model) to perturbed versions of the data point. The explanation is the set of weights of the features in the local model.</p></li>
</ul></li>
</ul></li>
<li><strong>Ethical Considerations:</strong>
<ul>
<li>Assessment of the potential ethical implications of the model, including fairness, bias, and privacy.</li>
<li>Implementation of measures to mitigate ethical risks, such as bias detection and mitigation techniques.</li>
<li>Transparency in the model’s ethical implications to stakeholders.</li>
</ul></li>
<li><strong>Regulatory Compliance:</strong>
<ul>
<li>Ensuring that the model complies with all relevant regulations and industry standards.</li>
<li>Documentation of compliance efforts and evidence of adherence to regulatory requirements.</li>
<li>Regular monitoring of regulatory changes and updates to the model governance framework.</li>
</ul></li>
<li><strong>Model Lifecycle Management:</strong>
<ul>
<li>A well-defined process for managing the entire lifecycle of a model, from development to retirement.</li>
<li>Criteria for retiring models that are no longer effective or relevant.</li>
<li>Archiving of model documentation and data after retirement.</li>
</ul></li>
<li><strong>Governance Structure and Roles:</strong>
<ul>
<li>Clearly defined roles and responsibilities for model governance, including model owners, developers, validators, and approvers.</li>
<li>Establishment of a model governance committee to oversee the model governance framework.</li>
<li>Training and awareness programs to educate employees about model governance principles.</li>
</ul></li>
</ol>
<p><strong>How to Narrate</strong></p>
<p>Here’s how to present this answer in an interview:</p>
<ol type="1">
<li><p><strong>Start with the “Why”:</strong> Begin by emphasizing the importance of model governance. Say something like: “Model governance is absolutely critical in today’s AI-driven world. Without it, organizations face substantial financial, reputational, compliance, operational, and ethical risks.” This immediately establishes the context and highlights the stakes.</p></li>
<li><p><strong>Outline the Framework:</strong> Provide a roadmap of the key components. “A robust model governance framework typically includes a model inventory, defined development standards, rigorous validation, comprehensive risk assessment, careful deployment and monitoring, thorough documentation, version control, stringent access control, audit trails, explainability considerations, attention to ethical implications, regulatory compliance, lifecycle management, and a defined governance structure.”</p></li>
<li><p><strong>Deep Dive into Core Components:</strong></p>
<ul>
<li><strong>Model Inventory:</strong> “The model inventory acts as a central registry for all models in use, detailing their purpose, data sources, developers, and risk level. It’s the foundation for tracking lineage and understanding impact.”</li>
<li><strong>Model Validation:</strong> “Independent validation is essential. A separate team rigorously assesses the model’s accuracy, stability, and robustness across diverse datasets to uncover potential weaknesses.”</li>
<li><strong>Risk Assessment:</strong> “Each model must undergo a risk assessment to identify potential problems. Models are categorized based on their risk level, which informs the level of oversight and mitigation strategies required.”</li>
<li><strong>Deployment and Monitoring:</strong> “Controlled deployment and continuous monitoring are crucial. We track key performance indicators like accuracy, precision, recall, and F1-score. I can explain these metrics in more detail, including their mathematical definitions, if you’d like.” (Pause here to gauge the interviewer’s interest. If they seem receptive, explain the equations. If not, move on.) “Alerting mechanisms are set up to detect performance degradation and trigger retraining.”</li>
<li><strong>Explainability:</strong> “Explainability is increasingly important, especially for high-stakes decisions. Techniques like SHAP values and LIME help us understand <em>how</em> the model arrives at its predictions, enhancing transparency.” If prompted, you can briefly describe the purpose of SHAP values and LIME.</li>
</ul></li>
<li><p><strong>Ethical and Regulatory Considerations:</strong> “Ethical considerations are paramount. We assess potential biases and implement mitigation techniques. Furthermore, we ensure compliance with all relevant regulations, adapting the framework as regulations evolve.”</p></li>
<li><p><strong>Lifecycle Management:</strong> “Models have a lifecycle. We have a process for retiring models that are no longer effective and archiving their documentation.”</p></li>
<li><p><strong>Governance Structure:</strong> “Finally, a defined governance structure with clear roles and responsibilities ensures accountability. A model governance committee oversees the framework and provides guidance.”</p></li>
<li><p><strong>Concluding Thought:</strong> “By implementing a comprehensive model governance framework, organizations can harness the power of AI responsibly, mitigate risks, and build trust in their models.”</p></li>
</ol>
<p><strong>Communication Tips:</strong></p>
<ul>
<li><strong>Pace Yourself:</strong> Don’t rush through the answer. Speak clearly and deliberately.</li>
<li><strong>Use Signposting:</strong> Use phrases like “First,” “Second,” “Next,” “Finally” to guide the interviewer through your response.</li>
<li><strong>Check for Understanding:</strong> After explaining a complex component, pause and ask, “Does that make sense?” or “Would you like me to elaborate on any of those points?”</li>
<li><strong>Be Ready to Elaborate:</strong> Have examples or real-world scenarios ready to illustrate the importance of each component.</li>
<li><strong>Stay High-Level When Appropriate:</strong> If the interviewer doesn’t seem interested in the technical details, focus on the broader concepts and their business implications.</li>
<li><strong>Express Confidence:</strong> Maintain a confident tone and demonstrate your expertise.</li>
<li><strong>Engage the Interviewer:</strong> Make eye contact and be responsive to their body language.</li>
</ul>
<p>By following this approach, you can deliver a comprehensive and compelling answer that showcases your senior-level knowledge of model governance.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>